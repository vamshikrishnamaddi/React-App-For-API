{"version":3,"sources":["copy.js"],"names":["fs","require","path","mkdirp","mkdirs","pathExists","utimes","utimesMillis","stat","copy","src","dest","opts","cb","filter","clobber","overwrite","preserveTimestamps","process","arch","console","warn","checkPaths","err","stats","srcStat","destStat","checkParentPaths","handleFilter","checkParentDir","destParent","dirname","dirExists","startCopy","onInclude","Promise","resolve","then","include","error","getStats","dereference","lstat","isDirectory","onDir","isFile","isCharacterDevice","isBlockDevice","onFile","isSymbolicLink","onLink","copyFile","mayCopyFile","unlink","errorOnExist","Error","setDestModeAndTimestamps","copyFileFallback","rs","createReadStream","on","once","ws","createWriteStream","mode","pipe","chmod","atime","mtime","mkDirAndCopy","copyDir","mkdir","readdir","items","copyDirItems","item","pop","copyDirItem","srcItem","join","destItem","readlink","resolvedSrc","cwd","symlink","resolvedDest","code","isSrcSubdir","copyLink","module","exports"],"mappings":"AAAA;;;;;;AAEA,UAAMA,KAAKC,QAAQ,0BAAR,CAAX;AACA,UAAMC,OAAOD,QAAQ,mBAAR,CAAb;AACA,UAAME,SAASF,QAAQ,WAAR,EAAqBG,MAApC;AACA,UAAMC,aAAaJ,QAAQ,gBAAR,EAA0BI,UAA7C;AACA,UAAMC,SAASL,QAAQ,gBAAR,EAA0BM,YAAzC;AACA,UAAMC,OAAOP,QAAQ,cAAR,CAAb;;AAEA,aAASQ,IAAT,CAAeC,GAAf,EAAoBC,IAApB,EAA0BC,IAA1B,EAAgCC,EAAhC,EAAoC;AAClC,UAAI,OAAOD,IAAP,KAAgB,UAAhB,IAA8B,CAACC,EAAnC,EAAuC;AACrCA,aAAKD,IAAL;AACAA,eAAO,EAAP;AACD,OAHD,MAGO,IAAI,OAAOA,IAAP,KAAgB,UAApB,EAAgC;AACrCA,eAAO,EAAEE,QAAQF,IAAV,EAAP;AACD;;AAEDC,WAAKA,MAAM,YAAY,CAAE,CAAzB;AACAD,aAAOA,QAAQ,EAAf;;AAEAA,WAAKG,OAAL,GAAe,aAAaH,IAAb,GAAoB,CAAC,CAACA,KAAKG,OAA3B,GAAqC,IAApD,CAXkC,CAWuB;AACzDH,WAAKI,SAAL,GAAiB,eAAeJ,IAAf,GAAsB,CAAC,CAACA,KAAKI,SAA7B,GAAyCJ,KAAKG,OAA/D,CAZkC,CAYqC;;AAEvE;AACA,UAAIH,KAAKK,kBAAL,IAA2BC,QAAQC,IAAR,KAAiB,MAAhD,EAAwD;AACtDC,gBAAQC,IAAR,CAAc;iEAAd;AAED;;AAEDb,WAAKc,UAAL,CAAgBZ,GAAhB,EAAqBC,IAArB,EAA2B,MAA3B,EAAmC,CAACY,GAAD,EAAMC,KAAN,KAAgB;AACjD,YAAID,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,cAAM,EAAEE,OAAF,EAAWC,QAAX,KAAwBF,KAA9B;AACAhB,aAAKmB,gBAAL,CAAsBjB,GAAtB,EAA2Be,OAA3B,EAAoCd,IAApC,EAA0C,MAA1C,EAAkDY,OAAO;AACvD,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,cAAIX,KAAKE,MAAT,EAAiB,OAAOc,aAAaC,cAAb,EAA6BH,QAA7B,EAAuChB,GAAvC,EAA4CC,IAA5C,EAAkDC,IAAlD,EAAwDC,EAAxD,CAAP;AACjB,iBAAOgB,eAAeH,QAAf,EAAyBhB,GAAzB,EAA8BC,IAA9B,EAAoCC,IAApC,EAA0CC,EAA1C,CAAP;AACD,SAJD;AAKD,OARD;AASD;;AAED,aAASgB,cAAT,CAAyBH,QAAzB,EAAmChB,GAAnC,EAAwCC,IAAxC,EAA8CC,IAA9C,EAAoDC,EAApD,EAAwD;AACtD,YAAMiB,aAAa5B,KAAK6B,OAAL,CAAapB,IAAb,CAAnB;AACAN,iBAAWyB,UAAX,EAAuB,CAACP,GAAD,EAAMS,SAAN,KAAoB;AACzC,YAAIT,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,YAAIS,SAAJ,EAAe,OAAOC,UAAUP,QAAV,EAAoBhB,GAApB,EAAyBC,IAAzB,EAA+BC,IAA/B,EAAqCC,EAArC,CAAP;AACfV,eAAO2B,UAAP,EAAmBP,OAAO;AACxB,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,iBAAOU,UAAUP,QAAV,EAAoBhB,GAApB,EAAyBC,IAAzB,EAA+BC,IAA/B,EAAqCC,EAArC,CAAP;AACD,SAHD;AAID,OAPD;AAQD;;AAED,aAASe,YAAT,CAAuBM,SAAvB,EAAkCR,QAAlC,EAA4ChB,GAA5C,EAAiDC,IAAjD,EAAuDC,IAAvD,EAA6DC,EAA7D,EAAiE;AAC/DsB,cAAQC,OAAR,CAAgBxB,KAAKE,MAAL,CAAYJ,GAAZ,EAAiBC,IAAjB,CAAhB,EAAwC0B,IAAxC,CAA6CC,WAAW;AACtD,YAAIA,OAAJ,EAAa,OAAOJ,UAAUR,QAAV,EAAoBhB,GAApB,EAAyBC,IAAzB,EAA+BC,IAA/B,EAAqCC,EAArC,CAAP;AACb,eAAOA,IAAP;AACD,OAHD,EAGG0B,SAAS1B,GAAG0B,KAAH,CAHZ;AAID;;AAED,aAASN,SAAT,CAAoBP,QAApB,EAA8BhB,GAA9B,EAAmCC,IAAnC,EAAyCC,IAAzC,EAA+CC,EAA/C,EAAmD;AACjD,UAAID,KAAKE,MAAT,EAAiB,OAAOc,aAAaY,QAAb,EAAuBd,QAAvB,EAAiChB,GAAjC,EAAsCC,IAAtC,EAA4CC,IAA5C,EAAkDC,EAAlD,CAAP;AACjB,aAAO2B,SAASd,QAAT,EAAmBhB,GAAnB,EAAwBC,IAAxB,EAA8BC,IAA9B,EAAoCC,EAApC,CAAP;AACD;;AAED,aAAS2B,QAAT,CAAmBd,QAAnB,EAA6BhB,GAA7B,EAAkCC,IAAlC,EAAwCC,IAAxC,EAA8CC,EAA9C,EAAkD;AAChD,YAAML,OAAOI,KAAK6B,WAAL,GAAmBzC,GAAGQ,IAAtB,GAA6BR,GAAG0C,KAA7C;AACAlC,WAAKE,GAAL,EAAU,CAACa,GAAD,EAAME,OAAN,KAAkB;AAC1B,YAAIF,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;;AAET,YAAIE,QAAQkB,WAAR,EAAJ,EAA2B,OAAOC,MAAMnB,OAAN,EAAeC,QAAf,EAAyBhB,GAAzB,EAA8BC,IAA9B,EAAoCC,IAApC,EAA0CC,EAA1C,CAAP,CAA3B,KACK,IAAIY,QAAQoB,MAAR,MACApB,QAAQqB,iBAAR,EADA,IAEArB,QAAQsB,aAAR,EAFJ,EAE6B,OAAOC,OAAOvB,OAAP,EAAgBC,QAAhB,EAA0BhB,GAA1B,EAA+BC,IAA/B,EAAqCC,IAArC,EAA2CC,EAA3C,CAAP,CAF7B,KAGA,IAAIY,QAAQwB,cAAR,EAAJ,EAA8B,OAAOC,OAAOxB,QAAP,EAAiBhB,GAAjB,EAAsBC,IAAtB,EAA4BC,IAA5B,EAAkCC,EAAlC,CAAP;AACpC,OARD;AASD;;AAED,aAASmC,MAAT,CAAiBvB,OAAjB,EAA0BC,QAA1B,EAAoChB,GAApC,EAAyCC,IAAzC,EAA+CC,IAA/C,EAAqDC,EAArD,EAAyD;AACvD,UAAI,CAACa,QAAL,EAAe,OAAOyB,SAAS1B,OAAT,EAAkBf,GAAlB,EAAuBC,IAAvB,EAA6BC,IAA7B,EAAmCC,EAAnC,CAAP;AACf,aAAOuC,YAAY3B,OAAZ,EAAqBf,GAArB,EAA0BC,IAA1B,EAAgCC,IAAhC,EAAsCC,EAAtC,CAAP;AACD;;AAED,aAASuC,WAAT,CAAsB3B,OAAtB,EAA+Bf,GAA/B,EAAoCC,IAApC,EAA0CC,IAA1C,EAAgDC,EAAhD,EAAoD;AAClD,UAAID,KAAKI,SAAT,EAAoB;AAClBhB,WAAGqD,MAAH,CAAU1C,IAAV,EAAgBY,OAAO;AACrB,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,iBAAO4B,SAAS1B,OAAT,EAAkBf,GAAlB,EAAuBC,IAAvB,EAA6BC,IAA7B,EAAmCC,EAAnC,CAAP;AACD,SAHD;AAID,OALD,MAKO,IAAID,KAAK0C,YAAT,EAAuB;AAC5B,eAAOzC,GAAG,IAAI0C,KAAJ,CAAW,IAAG5C,IAAK,kBAAnB,CAAH,CAAP;AACD,OAFM,MAEA,OAAOE,IAAP;AACR;;AAED,aAASsC,QAAT,CAAmB1B,OAAnB,EAA4Bf,GAA5B,EAAiCC,IAAjC,EAAuCC,IAAvC,EAA6CC,EAA7C,EAAiD;AAC/C,UAAI,OAAOb,GAAGmD,QAAV,KAAuB,UAA3B,EAAuC;AACrC,eAAOnD,GAAGmD,QAAH,CAAYzC,GAAZ,EAAiBC,IAAjB,EAAuBY,OAAO;AACnC,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,iBAAOiC,yBAAyB/B,OAAzB,EAAkCd,IAAlC,EAAwCC,IAAxC,EAA8CC,EAA9C,CAAP;AACD,SAHM,CAAP;AAID;AACD,aAAO4C,iBAAiBhC,OAAjB,EAA0Bf,GAA1B,EAA+BC,IAA/B,EAAqCC,IAArC,EAA2CC,EAA3C,CAAP;AACD;;AAED,aAAS4C,gBAAT,CAA2BhC,OAA3B,EAAoCf,GAApC,EAAyCC,IAAzC,EAA+CC,IAA/C,EAAqDC,EAArD,EAAyD;AACvD,YAAM6C,KAAK1D,GAAG2D,gBAAH,CAAoBjD,GAApB,CAAX;AACAgD,SAAGE,EAAH,CAAM,OAAN,EAAerC,OAAOV,GAAGU,GAAH,CAAtB,EAA+BsC,IAA/B,CAAoC,MAApC,EAA4C,MAAM;AAChD,cAAMC,KAAK9D,GAAG+D,iBAAH,CAAqBpD,IAArB,EAA2B,EAAEqD,MAAMvC,QAAQuC,IAAhB,EAA3B,CAAX;AACAF,WAAGF,EAAH,CAAM,OAAN,EAAerC,OAAOV,GAAGU,GAAH,CAAtB,EACGqC,EADH,CACM,MADN,EACc,MAAMF,GAAGO,IAAH,CAAQH,EAAR,CADpB,EAEGD,IAFH,CAEQ,OAFR,EAEiB,MAAML,yBAAyB/B,OAAzB,EAAkCd,IAAlC,EAAwCC,IAAxC,EAA8CC,EAA9C,CAFvB;AAGD,OALD;AAMD;;AAED,aAAS2C,wBAAT,CAAmC/B,OAAnC,EAA4Cd,IAA5C,EAAkDC,IAAlD,EAAwDC,EAAxD,EAA4D;AAC1Db,SAAGkE,KAAH,CAASvD,IAAT,EAAec,QAAQuC,IAAvB,EAA6BzC,OAAO;AAClC,YAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,YAAIX,KAAKK,kBAAT,EAA6B;AAC3B,iBAAOX,OAAOK,IAAP,EAAac,QAAQ0C,KAArB,EAA4B1C,QAAQ2C,KAApC,EAA2CvD,EAA3C,CAAP;AACD;AACD,eAAOA,IAAP;AACD,OAND;AAOD;;AAED,aAAS+B,KAAT,CAAgBnB,OAAhB,EAAyBC,QAAzB,EAAmChB,GAAnC,EAAwCC,IAAxC,EAA8CC,IAA9C,EAAoDC,EAApD,EAAwD;AACtD,UAAI,CAACa,QAAL,EAAe,OAAO2C,aAAa5C,OAAb,EAAsBf,GAAtB,EAA2BC,IAA3B,EAAiCC,IAAjC,EAAuCC,EAAvC,CAAP;AACf,UAAIa,YAAY,CAACA,SAASiB,WAAT,EAAjB,EAAyC;AACvC,eAAO9B,GAAG,IAAI0C,KAAJ,CAAW,mCAAkC5C,IAAK,qBAAoBD,GAAI,IAA1E,CAAH,CAAP;AACD;AACD,aAAO4D,QAAQ5D,GAAR,EAAaC,IAAb,EAAmBC,IAAnB,EAAyBC,EAAzB,CAAP;AACD;;AAED,aAASwD,YAAT,CAAuB5C,OAAvB,EAAgCf,GAAhC,EAAqCC,IAArC,EAA2CC,IAA3C,EAAiDC,EAAjD,EAAqD;AACnDb,SAAGuE,KAAH,CAAS5D,IAAT,EAAeY,OAAO;AACpB,YAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT+C,gBAAQ5D,GAAR,EAAaC,IAAb,EAAmBC,IAAnB,EAAyBW,OAAO;AAC9B,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,iBAAOvB,GAAGkE,KAAH,CAASvD,IAAT,EAAec,QAAQuC,IAAvB,EAA6BnD,EAA7B,CAAP;AACD,SAHD;AAID,OAND;AAOD;;AAED,aAASyD,OAAT,CAAkB5D,GAAlB,EAAuBC,IAAvB,EAA6BC,IAA7B,EAAmCC,EAAnC,EAAuC;AACrCb,SAAGwE,OAAH,CAAW9D,GAAX,EAAgB,CAACa,GAAD,EAAMkD,KAAN,KAAgB;AAC9B,YAAIlD,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,eAAOmD,aAAaD,KAAb,EAAoB/D,GAApB,EAAyBC,IAAzB,EAA+BC,IAA/B,EAAqCC,EAArC,CAAP;AACD,OAHD;AAID;;AAED,aAAS6D,YAAT,CAAuBD,KAAvB,EAA8B/D,GAA9B,EAAmCC,IAAnC,EAAyCC,IAAzC,EAA+CC,EAA/C,EAAmD;AACjD,YAAM8D,OAAOF,MAAMG,GAAN,EAAb;AACA,UAAI,CAACD,IAAL,EAAW,OAAO9D,IAAP;AACX,aAAOgE,YAAYJ,KAAZ,EAAmBE,IAAnB,EAAyBjE,GAAzB,EAA8BC,IAA9B,EAAoCC,IAApC,EAA0CC,EAA1C,CAAP;AACD;;AAED,aAASgE,WAAT,CAAsBJ,KAAtB,EAA6BE,IAA7B,EAAmCjE,GAAnC,EAAwCC,IAAxC,EAA8CC,IAA9C,EAAoDC,EAApD,EAAwD;AACtD,YAAMiE,UAAU5E,KAAK6E,IAAL,CAAUrE,GAAV,EAAeiE,IAAf,CAAhB;AACA,YAAMK,WAAW9E,KAAK6E,IAAL,CAAUpE,IAAV,EAAgBgE,IAAhB,CAAjB;AACAnE,WAAKc,UAAL,CAAgBwD,OAAhB,EAAyBE,QAAzB,EAAmC,MAAnC,EAA2C,CAACzD,GAAD,EAAMC,KAAN,KAAgB;AACzD,YAAID,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,cAAM,EAAEG,QAAF,KAAeF,KAArB;AACAS,kBAAUP,QAAV,EAAoBoD,OAApB,EAA6BE,QAA7B,EAAuCpE,IAAvC,EAA6CW,OAAO;AAClD,cAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,iBAAOmD,aAAaD,KAAb,EAAoB/D,GAApB,EAAyBC,IAAzB,EAA+BC,IAA/B,EAAqCC,EAArC,CAAP;AACD,SAHD;AAID,OAPD;AAQD;;AAED,aAASqC,MAAT,CAAiBxB,QAAjB,EAA2BhB,GAA3B,EAAgCC,IAAhC,EAAsCC,IAAtC,EAA4CC,EAA5C,EAAgD;AAC9Cb,SAAGiF,QAAH,CAAYvE,GAAZ,EAAiB,CAACa,GAAD,EAAM2D,WAAN,KAAsB;AACrC,YAAI3D,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,YAAIX,KAAK6B,WAAT,EAAsB;AACpByC,wBAAchF,KAAKkC,OAAL,CAAalB,QAAQiE,GAAR,EAAb,EAA4BD,WAA5B,CAAd;AACD;;AAED,YAAI,CAACxD,QAAL,EAAe;AACb,iBAAO1B,GAAGoF,OAAH,CAAWF,WAAX,EAAwBvE,IAAxB,EAA8BE,EAA9B,CAAP;AACD,SAFD,MAEO;AACLb,aAAGiF,QAAH,CAAYtE,IAAZ,EAAkB,CAACY,GAAD,EAAM8D,YAAN,KAAuB;AACvC,gBAAI9D,GAAJ,EAAS;AACP;AACA;AACA;AACA,kBAAIA,IAAI+D,IAAJ,KAAa,QAAb,IAAyB/D,IAAI+D,IAAJ,KAAa,SAA1C,EAAqD,OAAOtF,GAAGoF,OAAH,CAAWF,WAAX,EAAwBvE,IAAxB,EAA8BE,EAA9B,CAAP;AACrD,qBAAOA,GAAGU,GAAH,CAAP;AACD;AACD,gBAAIX,KAAK6B,WAAT,EAAsB;AACpB4C,6BAAenF,KAAKkC,OAAL,CAAalB,QAAQiE,GAAR,EAAb,EAA4BE,YAA5B,CAAf;AACD;AACD,gBAAI7E,KAAK+E,WAAL,CAAiBL,WAAjB,EAA8BG,YAA9B,CAAJ,EAAiD;AAC/C,qBAAOxE,GAAG,IAAI0C,KAAJ,CAAW,gBAAe2B,WAAY,mCAAkCG,YAAa,IAArF,CAAH,CAAP;AACD;;AAED;AACA;AACA;AACA,gBAAI3D,SAASiB,WAAT,MAA0BnC,KAAK+E,WAAL,CAAiBF,YAAjB,EAA+BH,WAA/B,CAA9B,EAA2E;AACzE,qBAAOrE,GAAG,IAAI0C,KAAJ,CAAW,qBAAoB8B,YAAa,WAAUH,WAAY,IAAlE,CAAH,CAAP;AACD;AACD,mBAAOM,SAASN,WAAT,EAAsBvE,IAAtB,EAA4BE,EAA5B,CAAP;AACD,WAtBD;AAuBD;AACF,OAjCD;AAkCD;;AAED,aAAS2E,QAAT,CAAmBN,WAAnB,EAAgCvE,IAAhC,EAAsCE,EAAtC,EAA0C;AACxCb,SAAGqD,MAAH,CAAU1C,IAAV,EAAgBY,OAAO;AACrB,YAAIA,GAAJ,EAAS,OAAOV,GAAGU,GAAH,CAAP;AACT,eAAOvB,GAAGoF,OAAH,CAAWF,WAAX,EAAwBvE,IAAxB,EAA8BE,EAA9B,CAAP;AACD,OAHD;AAID;;AAED4E,WAAOC,OAAP,GAAiBjF,IAAjB","file":"copy.js","sourcesContent":["'use strict'\n\nconst fs = require('graceful-fs')\nconst path = require('path')\nconst mkdirp = require('../mkdirs').mkdirs\nconst pathExists = require('../path-exists').pathExists\nconst utimes = require('../util/utimes').utimesMillis\nconst stat = require('../util/stat')\n\nfunction copy (src, dest, opts, cb) {\n  if (typeof opts === 'function' && !cb) {\n    cb = opts\n    opts = {}\n  } else if (typeof opts === 'function') {\n    opts = { filter: opts }\n  }\n\n  cb = cb || function () {}\n  opts = opts || {}\n\n  opts.clobber = 'clobber' in opts ? !!opts.clobber : true // default to true for now\n  opts.overwrite = 'overwrite' in opts ? !!opts.overwrite : opts.clobber // overwrite falls back to clobber\n\n  // Warn about using preserveTimestamps on 32-bit node\n  if (opts.preserveTimestamps && process.arch === 'ia32') {\n    console.warn(`fs-extra: Using the preserveTimestamps option in 32-bit node is not recommended;\\n\n    see https://github.com/jprichardson/node-fs-extra/issues/269`)\n  }\n\n  stat.checkPaths(src, dest, 'copy', (err, stats) => {\n    if (err) return cb(err)\n    const { srcStat, destStat } = stats\n    stat.checkParentPaths(src, srcStat, dest, 'copy', err => {\n      if (err) return cb(err)\n      if (opts.filter) return handleFilter(checkParentDir, destStat, src, dest, opts, cb)\n      return checkParentDir(destStat, src, dest, opts, cb)\n    })\n  })\n}\n\nfunction checkParentDir (destStat, src, dest, opts, cb) {\n  const destParent = path.dirname(dest)\n  pathExists(destParent, (err, dirExists) => {\n    if (err) return cb(err)\n    if (dirExists) return startCopy(destStat, src, dest, opts, cb)\n    mkdirp(destParent, err => {\n      if (err) return cb(err)\n      return startCopy(destStat, src, dest, opts, cb)\n    })\n  })\n}\n\nfunction handleFilter (onInclude, destStat, src, dest, opts, cb) {\n  Promise.resolve(opts.filter(src, dest)).then(include => {\n    if (include) return onInclude(destStat, src, dest, opts, cb)\n    return cb()\n  }, error => cb(error))\n}\n\nfunction startCopy (destStat, src, dest, opts, cb) {\n  if (opts.filter) return handleFilter(getStats, destStat, src, dest, opts, cb)\n  return getStats(destStat, src, dest, opts, cb)\n}\n\nfunction getStats (destStat, src, dest, opts, cb) {\n  const stat = opts.dereference ? fs.stat : fs.lstat\n  stat(src, (err, srcStat) => {\n    if (err) return cb(err)\n\n    if (srcStat.isDirectory()) return onDir(srcStat, destStat, src, dest, opts, cb)\n    else if (srcStat.isFile() ||\n             srcStat.isCharacterDevice() ||\n             srcStat.isBlockDevice()) return onFile(srcStat, destStat, src, dest, opts, cb)\n    else if (srcStat.isSymbolicLink()) return onLink(destStat, src, dest, opts, cb)\n  })\n}\n\nfunction onFile (srcStat, destStat, src, dest, opts, cb) {\n  if (!destStat) return copyFile(srcStat, src, dest, opts, cb)\n  return mayCopyFile(srcStat, src, dest, opts, cb)\n}\n\nfunction mayCopyFile (srcStat, src, dest, opts, cb) {\n  if (opts.overwrite) {\n    fs.unlink(dest, err => {\n      if (err) return cb(err)\n      return copyFile(srcStat, src, dest, opts, cb)\n    })\n  } else if (opts.errorOnExist) {\n    return cb(new Error(`'${dest}' already exists`))\n  } else return cb()\n}\n\nfunction copyFile (srcStat, src, dest, opts, cb) {\n  if (typeof fs.copyFile === 'function') {\n    return fs.copyFile(src, dest, err => {\n      if (err) return cb(err)\n      return setDestModeAndTimestamps(srcStat, dest, opts, cb)\n    })\n  }\n  return copyFileFallback(srcStat, src, dest, opts, cb)\n}\n\nfunction copyFileFallback (srcStat, src, dest, opts, cb) {\n  const rs = fs.createReadStream(src)\n  rs.on('error', err => cb(err)).once('open', () => {\n    const ws = fs.createWriteStream(dest, { mode: srcStat.mode })\n    ws.on('error', err => cb(err))\n      .on('open', () => rs.pipe(ws))\n      .once('close', () => setDestModeAndTimestamps(srcStat, dest, opts, cb))\n  })\n}\n\nfunction setDestModeAndTimestamps (srcStat, dest, opts, cb) {\n  fs.chmod(dest, srcStat.mode, err => {\n    if (err) return cb(err)\n    if (opts.preserveTimestamps) {\n      return utimes(dest, srcStat.atime, srcStat.mtime, cb)\n    }\n    return cb()\n  })\n}\n\nfunction onDir (srcStat, destStat, src, dest, opts, cb) {\n  if (!destStat) return mkDirAndCopy(srcStat, src, dest, opts, cb)\n  if (destStat && !destStat.isDirectory()) {\n    return cb(new Error(`Cannot overwrite non-directory '${dest}' with directory '${src}'.`))\n  }\n  return copyDir(src, dest, opts, cb)\n}\n\nfunction mkDirAndCopy (srcStat, src, dest, opts, cb) {\n  fs.mkdir(dest, err => {\n    if (err) return cb(err)\n    copyDir(src, dest, opts, err => {\n      if (err) return cb(err)\n      return fs.chmod(dest, srcStat.mode, cb)\n    })\n  })\n}\n\nfunction copyDir (src, dest, opts, cb) {\n  fs.readdir(src, (err, items) => {\n    if (err) return cb(err)\n    return copyDirItems(items, src, dest, opts, cb)\n  })\n}\n\nfunction copyDirItems (items, src, dest, opts, cb) {\n  const item = items.pop()\n  if (!item) return cb()\n  return copyDirItem(items, item, src, dest, opts, cb)\n}\n\nfunction copyDirItem (items, item, src, dest, opts, cb) {\n  const srcItem = path.join(src, item)\n  const destItem = path.join(dest, item)\n  stat.checkPaths(srcItem, destItem, 'copy', (err, stats) => {\n    if (err) return cb(err)\n    const { destStat } = stats\n    startCopy(destStat, srcItem, destItem, opts, err => {\n      if (err) return cb(err)\n      return copyDirItems(items, src, dest, opts, cb)\n    })\n  })\n}\n\nfunction onLink (destStat, src, dest, opts, cb) {\n  fs.readlink(src, (err, resolvedSrc) => {\n    if (err) return cb(err)\n    if (opts.dereference) {\n      resolvedSrc = path.resolve(process.cwd(), resolvedSrc)\n    }\n\n    if (!destStat) {\n      return fs.symlink(resolvedSrc, dest, cb)\n    } else {\n      fs.readlink(dest, (err, resolvedDest) => {\n        if (err) {\n          // dest exists and is a regular file or directory,\n          // Windows may throw UNKNOWN error. If dest already exists,\n          // fs throws error anyway, so no need to guard against it here.\n          if (err.code === 'EINVAL' || err.code === 'UNKNOWN') return fs.symlink(resolvedSrc, dest, cb)\n          return cb(err)\n        }\n        if (opts.dereference) {\n          resolvedDest = path.resolve(process.cwd(), resolvedDest)\n        }\n        if (stat.isSrcSubdir(resolvedSrc, resolvedDest)) {\n          return cb(new Error(`Cannot copy '${resolvedSrc}' to a subdirectory of itself, '${resolvedDest}'.`))\n        }\n\n        // do not copy if src is a subdir of dest since unlinking\n        // dest in this case would result in removing src contents\n        // and therefore a broken symlink would be created.\n        if (destStat.isDirectory() && stat.isSrcSubdir(resolvedDest, resolvedSrc)) {\n          return cb(new Error(`Cannot overwrite '${resolvedDest}' with '${resolvedSrc}'.`))\n        }\n        return copyLink(resolvedSrc, dest, cb)\n      })\n    }\n  })\n}\n\nfunction copyLink (resolvedSrc, dest, cb) {\n  fs.unlink(dest, err => {\n    if (err) return cb(err)\n    return fs.symlink(resolvedSrc, dest, cb)\n  })\n}\n\nmodule.exports = copy\n"]}